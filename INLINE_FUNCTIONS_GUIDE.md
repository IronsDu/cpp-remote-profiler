# å†…è”å‡½æ•°æ”¯æŒ - æµ‹è¯•æŒ‡å—

## ðŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®å·²æˆåŠŸå®žçŽ°å¯¹ gperftools pprof é£Žæ ¼å†…è”å‡½æ•°çš„å®Œæ•´æ”¯æŒï¼ŒåŒ…æ‹¬ï¼š

1. âœ… åŽç«¯ `/pprof/symbol` æŽ¥å£å¢žå¼ºï¼ˆæ”¯æŒ `--` åˆ†éš”çš„å†…è”å‡½æ•°é“¾ï¼‰
2. âœ… é›†æˆ backward-cpp ç¬¦å·åŒ–åº“
3. âœ… å‰ç«¯ç«ç„°å›¾æ¸²æŸ“å™¨æ›´æ–°ï¼ˆæ”¯æŒå†…è”å‡½æ•°å¯è§†åŒ–ï¼‰

## ðŸ”§ æŠ€æœ¯å®žçŽ°

### 1. åŽç«¯æ”¹åŠ¨

#### æ–‡ä»¶ï¼š`src/profiler_manager.cpp`
- **ä¿®æ”¹äº† `resolveSymbol` å‡½æ•°**ï¼š
  - æ·»åŠ  `addr2line -i` å‚æ•°ä»¥èŽ·å–å†…è”å‡½æ•°ä¿¡æ¯
  - è§£æžå¤šè¡Œè¾“å‡ºï¼Œæå–å®Œæ•´çš„å†…è”è°ƒç”¨é“¾
  - ä½¿ç”¨ `--` åˆ†éš”ç¬¦è¿žæŽ¥å‡½æ•°åï¼ˆgperftools pprof æ ¼å¼ï¼‰

#### æ–°å¢žæ–‡ä»¶ï¼š
- `include/symbolize.h` - ç¬¦å·åŒ–å™¨æŽ¥å£å®šä¹‰
- `src/symbolize.cpp` - backward-cpp ç¬¦å·åŒ–å™¨å®žçŽ°
- `include/profiler_manager.h` - æ·»åŠ ç¬¦å·åŒ–å™¨æˆå‘˜å’Œæ–°æ–¹æ³•

### 2. å‰ç«¯æ”¹åŠ¨

#### æ–‡ä»¶ï¼š`web/flamegraph.html`
- **æ›´æ–° `parseCollapsedFormat` å‡½æ•°**ï¼š
  - è¯†åˆ« `--` åˆ†éš”çš„å†…è”å‡½æ•°ï¼ˆä¾‹å¦‚ï¼š`main_func--inline_func1--inline_func2`ï¼‰
  - åˆ›å»ºç‰¹æ®Šçš„å†…è”å‡½æ•°èŠ‚ç‚¹ï¼ˆ`isInlined: true`ï¼‰

- **æ›´æ–° `getColor` å‡½æ•°**ï¼š
  - å†…è”å‡½æ•°ä½¿ç”¨ç´«è‰²/è“è‰²ç³»ï¼ˆhue: 240-300ï¼‰
  - æ™®é€šå‡½æ•°ä½¿ç”¨æ©™è‰²/é»„è‰²ç³»ï¼ˆhue: 30-60ï¼‰

- **æ›´æ–°æ¸²æŸ“é€»è¾‘**ï¼š
  - å†…è”å‡½æ•°ä½¿ç”¨æ›´äº®çš„è¾¹æ¡†ï¼ˆ`lineWidth: 2`ï¼‰
  - å†…è”å‡½æ•°èŠ‚ç‚¹åœ¨ç«ç„°å›¾ä¸­è‡ªåŠ¨å±•å¼€

## ðŸš€ æž„å»ºå’Œæµ‹è¯•

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

```bash
cd /mnt/f/code/cpp-remote-profiler

# å®‰è£… vcpkg ä¾èµ–ï¼ˆåŒ…æ‹¬ backward-cppï¼‰
./vcpkg/vcpkg install

# æˆ–è€…æ‰‹åŠ¨å®‰è£…
./vcpkg/vcpkg install backward-cpp
```

### æ­¥éª¤ 2ï¼šæž„å»ºé¡¹ç›®

```bash
# ä½¿ç”¨æž„å»ºè„šæœ¬
./build-with-vcpkg.sh

# æˆ–è€…æ‰‹åŠ¨æž„å»º
mkdir build && cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=/path/to/vcpkg/scripts/buildsystems/vcpkg.cmake
make
```

### æ­¥éª¤ 3ï¼šè¿è¡Œæµ‹è¯•ç¨‹åº

```bash
cd build
./profiler_example
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:8080` å¯åŠ¨ã€‚

### æ­¥éª¤ 4ï¼šæµ‹è¯•å†…è”å‡½æ•°æ˜¾ç¤º

1. **è®¿é—®ç«ç„°å›¾é¡µé¢**ï¼š
   ```
   http://localhost:8080/flamegraph
   ```

2. **ç”Ÿæˆ profile æ•°æ®**ï¼š
   - ç‚¹å‡» "åˆ·æ–°æ•°æ®" æŒ‰é’®
   - æˆ–å¯åŠ¨ CPU profiler é‡‡æ ·ä¸€æ®µæ—¶é—´

3. **è§‚å¯Ÿå†…è”å‡½æ•°**ï¼š
   - **ç´«è‰²/è“è‰²** çš„æ–¹å—è¡¨ç¤ºå†…è”å‡½æ•°
   - **æ©™è‰²/é»„è‰²** çš„æ–¹å—è¡¨ç¤ºæ™®é€šå‡½æ•°
   - å†…è”å‡½æ•°ä¼šæœ‰æ›´äº®çš„ç™½è‰²è¾¹æ¡†

## ðŸ“Š æ•°æ®æ ¼å¼

### Collapsed æ ¼å¼ï¼ˆå¸¦å†…è”å‡½æ•°ï¼‰

```
main_function--inline_func1--inline_func2 100
main_function--inline_func3 50
normal_function 200
```

### `/pprof/symbol` å“åº”æ ¼å¼

```
0x400500 main_func--inline_a--inline_b
0x400600 normal_func
```

## ðŸŽ¨ è§†è§‰ç¤ºä¾‹

### ç«ç„°å›¾ä¸­çš„å†…è”å‡½æ•°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  main_function (æ©™è‰²)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [inline_func1] (ç´«è‰²)  â”‚  [inline_func2] (ç´«è‰²)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  normal_function (æ©™è‰²)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ” API ä½¿ç”¨ç¤ºä¾‹

### ä½¿ç”¨ `/pprof/symbol` æŽ¥å£

```bash
# POST è¯·æ±‚
curl -X POST http://localhost:8080/pprof/symbol \
  -d "0x400500\n0x400600\n0x400700"

# å“åº”
0x400500 main_function--inline_func1--inline_func2
0x400600 normal_function
0x400700 std::sort--std::__sort
```

### ä½¿ç”¨æ–°çš„ç¬¦å·åŒ–å™¨ï¼ˆC++ï¼‰

```cpp
#include "symbolize.h"

auto symbolizer = profiler::createSymbolizer();

// ç¬¦å·åŒ–å•ä¸ªåœ°å€
void* addr = ...;
auto frames = symbolizer->symbolize(addr);

for (const auto& frame : frames) {
    std::cout << frame.function_name
              << " at " << frame.source_file
              << ":" << frame.line << "\n";
    if (frame.is_inlined) {
        std::cout << "  (inlined)\n";
    }
}
```

## ðŸ› æ•…éšœæŽ’é™¤

### é—®é¢˜ 1ï¼šç¼–è¯‘é”™è¯¯ "backward.hpp: No such file"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿ backward-cpp å·²æ­£ç¡®å®‰è£…
./vcpkg/vcpkg install backward-cpp

# é‡æ–°è¿è¡Œ CMake
cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=/path/to/vcpkg/scripts/buildsystems/vcpkg.cmake
make
```

### é—®é¢˜ 2ï¼šå†…è”å‡½æ•°ä¸æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… ç¡®ä¿ä½¿ç”¨ `addr2line -i`ï¼ˆå·²åœ¨ä»£ç ä¸­å®žçŽ°ï¼‰
2. âœ… æ£€æŸ¥ç¼–è¯‘æ—¶æ˜¯å¦ä½¿ç”¨äº†è°ƒè¯•ç¬¦å·ï¼ˆ`-g`ï¼‰
3. âœ… ç¡®ä¿ç¼–è¯‘æ—¶æœªå¼€å¯ä¼˜åŒ–ï¼ˆ`-O0`ï¼‰ï¼Œæˆ–è‡³å°‘ä¿ç•™éƒ¨åˆ†è°ƒè¯•ä¿¡æ¯

### é—®é¢˜ 3ï¼šå‰ç«¯æ— æ³•è§£æžå†…è”å‡½æ•°

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript é”™è¯¯
- ç¡®è®¤åŽç«¯è¿”å›žçš„æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆä½¿ç”¨ `--` åˆ†éš”ç¬¦ï¼‰
- æ£€æŸ¥ `parseCollapsedFormat` å‡½æ•°çš„è§£æžé€»è¾‘

## ðŸ“ ç›¸å…³ä»£ç æ–‡ä»¶

### åŽç«¯
- `src/profiler_manager.cpp:432-501` - å¢žå¼ºçš„ resolveSymbol å‡½æ•°
- `src/profiler_manager.cpp:503-537` - æ–°çš„ resolveSymbolWithBackward å‡½æ•°
- `src/symbolize.cpp` - backward-cpp ç¬¦å·åŒ–å™¨å®žçŽ°
- `include/symbolize.h` - ç¬¦å·åŒ–å™¨æŽ¥å£

### å‰ç«¯
- `web/flamegraph.html:361-467` - æ›´æ–°çš„ parseCollapsedFormat å‡½æ•°
- `web/flamegraph.html:559-588` - æ›´æ–°çš„ getColor å‡½æ•°

## ðŸŽ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

å»ºè®®çš„åŽç»­æ”¹è¿›ï¼š

1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ç¼“å­˜ç¬¦å·åŒ–ç»“æžœï¼Œé¿å…é‡å¤è§£æž
   - æ‰¹é‡ç¬¦å·åŒ– APIï¼ˆå‡å°‘ HTTP è¯·æ±‚æ¬¡æ•°ï¼‰

2. **UI å¢žå¼º**ï¼š
   - æ·»åŠ "æ˜¾ç¤º/éšè—å†…è”å‡½æ•°"çš„åˆ‡æ¢æŒ‰é’®
   - å†…è”å‡½æ•°çš„æŠ˜å /å±•å¼€åŠŸèƒ½
   - å†…è”å‡½æ•°ç»Ÿè®¡ä¿¡æ¯

3. **åŠŸèƒ½æ‰©å±•**ï¼š
   - æ”¯æŒæºä»£ç è¡Œçº§åˆ«çš„ç«ç„°å›¾
   - å¯¼å‡ºå¸¦æœ‰å†…è”å‡½æ•°ä¿¡æ¯çš„ SVG/å›¾ç‰‡

## ðŸ“š å‚è€ƒèµ„æ–™

- [gperftools pprof è„šæœ¬](https://github.com/gperftools/gperftools/blob/master/src/pprof)
- [backward-cpp æ–‡æ¡£](https://github.com/bombela/backward-cpp)
- [ç«ç„°å›¾å¯è§†åŒ–åŽŸç†](http://www.brendangregg.com/flamegraphs.html)
