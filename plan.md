# C++ Remote Profiler æ•´ä½“è§„åˆ’

## é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: C++ Remote Profiler
**ç›®æ ‡**: ç±»ä¼¼ Go pprof çš„ C++ è¿œç¨‹æ€§èƒ½åˆ†æå·¥å…·
**æŠ€æœ¯æ ˆ**: gperftools + Drogon + vcpkg
**å¼€å‘è¯­è¨€**: C++20

---

## æ ¸å¿ƒæ¶æ„

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     C++ Remote Profiler                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ HTTP Server â”‚ â†â”€â”€â†’ â”‚ Drogon      â”‚ â†â”€â”€â†’ â”‚ gperftoolsâ”‚ â”‚
â”‚  â”‚   (Drogon)   â”‚      â”‚ Framework   â”‚      â”‚  Profiler  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                      â†“                      â†“      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web UI     â”‚      â”‚ REST API    â”‚      â”‚Profile  â”‚ â”‚
â”‚  â”‚  (HTML/JS)   â”‚ â†â”€â”€â†’ â”‚  Handlers   â”‚ â†â”€â”€â†’ â”‚  Files  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¨¡å—åˆ’åˆ†

#### åç«¯æ¨¡å— (C++)
- `profiler_manager.{h,cpp}` - Profiler ç®¡ç†æ ¸å¿ƒ
- `symbolize.{h,cpp}` - ç¬¦å·åŒ–å¼•æ“
- `stack_collector.{h,cpp}` - è°ƒç”¨æ ˆæ”¶é›†
- `profile_parser.{h,cpp}` - Profile æ•°æ®è§£æ
- `example/main.cpp` - ç¤ºä¾‹ç¨‹åº

#### å‰ç«¯æ¨¡å— (Web)
- `index.html` - ä¸»æ§åˆ¶é¢æ¿
- `show_svg.html` - CPU ç«ç„°å›¾æ˜¾ç¤º
- `show_heap_svg.html` - Heap ç«ç„°å›¾æ˜¾ç¤º
- `flamegraph.html` - ç«ç„°å›¾ç»„ä»¶

#### å·¥å…·æ¨¡å—
- `embed_pprof.h` - åµŒå…¥çš„ gperftools pprof è„šæœ¬
- FlameGraph å·¥å…· - ç«ç„°å›¾ç”Ÿæˆ

---

## å·²å®ŒæˆåŠŸèƒ½ âœ…

### 1. æ ¸å¿ƒåŠŸèƒ½

#### 1.1 CPU Profiling âœ…
- [x] é›†æˆ gperftools CPU profiler
- [x] å¯åŠ¨/åœæ­¢ CPU profiling
- [x] é…ç½®é‡‡æ ·æ—¶é•¿
- [x] è‡ªåŠ¨ç”Ÿæˆ profile æ–‡ä»¶

#### 1.2 Heap Profiling âœ…
- [x] é›†æˆ gperftools heap profiler
- [x] å¯åŠ¨/åœæ­¢ heap profiling
- [x] é…ç½®é‡‡æ ·æ—¶é•¿
- [x] è‡ªåŠ¨ç”Ÿæˆ profile æ–‡ä»¶

#### 1.3 Web æœåŠ¡å™¨ âœ…
- [x] åŸºäº Drogon æ¡†æ¶çš„ HTTP æœåŠ¡å™¨
- [x] RESTful API æ¥å£
- [x] é™æ€æ–‡ä»¶æœåŠ¡
- [x] CORS æ”¯æŒ

### 2. API æ¥å£

#### 2.1 CPU Profiling API âœ…
- [x] `GET /api/cpu/start` - å¯åŠ¨ CPU profiler
- [x] `GET /api/cpu/stop` - åœæ­¢ CPU profiler
- [x] `GET /api/cpu/analyze?duration=N` - ä¸€é”®å¼åˆ†æå¹¶ç”Ÿæˆ SVG
- [x] `GET /api/cpu/status` - æŸ¥è¯¢ profiler çŠ¶æ€
- [x] `GET /api/cpu/profile` - ä¸‹è½½ profile æ–‡ä»¶
- [x] `GET /api/cpu/text` - è·å–æ–‡æœ¬æ ¼å¼åˆ†æç»“æœ
- [x] `GET /api/cpu/samples` - è·å–åŸå§‹é‡‡æ ·æ•°æ®
- [x] `GET /api/cpu/collapsed` - è·å– collapsed æ ¼å¼æ•°æ®

#### 2.2 Heap Profiling API âœ…
- [x] `GET /api/heap/start` - å¯åŠ¨ heap profiler
- [x] `GET /api/heap/stop` - åœæ­¢ heap profiler
- [x] `GET /api/heap/analyze?duration=N` - ä¸€é”®å¼åˆ†æå¹¶ç”Ÿæˆ SVG
- [x] `GET /api/heap/status` - æŸ¥è¯¢ profiler çŠ¶æ€
- [x] `GET /api/heap/profile` - ä¸‹è½½ profile æ–‡ä»¶

#### 2.3 é€šç”¨ API âœ…
- [x] `GET /api/status` - å…¨å±€çŠ¶æ€
- [x] `GET /api/list` - åˆ—å‡ºæ‰€æœ‰ profile æ–‡ä»¶

### 3. ç¬¦å·åŒ–ç³»ç»Ÿ

#### 3.1 å¤šå±‚ç¬¦å·åŒ–ç­–ç•¥ âœ…
- [x] **Layer 1**: backward-cpp (C++ stack trace)
- [x] **Layer 2**: dladdr (åŠ¨æ€é“¾æ¥ä¿¡æ¯)
- [x] **Layer 3**: addr2line (ç¬¦å·è¡¨æŸ¥è¯¢)
- [x] **Layer 4**: é™çº§æ˜¾ç¤ºåŸå§‹åœ°å€

**å®ç°ä»£ç **:
```cpp
// src/symbolize.cpp
std::string ProfilerManager::resolveSymbolWithBackward(void* address)
```

#### 3.2 PIE å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒ âœ…
- [x] è®¡ç®—ç›¸å¯¹åœ°å€ (address - dli_fbase)
- [x] ä½¿ç”¨æ­£ç¡®çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- [x] æ”¯æŒåŠ¨æ€åº“ç¬¦å·æŸ¥è¯¢

### 4. å‰ç«¯ç•Œé¢

#### 4.1 ä¸»æ§åˆ¶é¢æ¿ âœ…
- [x] çŠ¶æ€æ˜¾ç¤º
- [x] Profiler æ§åˆ¶æŒ‰é’®
- [x] é…ç½®é€‰é¡¹
- [x] å“åº”å¼è®¾è®¡

#### 4.2 ç«ç„°å›¾æ˜¾ç¤º âœ…
- [x] CPU ç«ç„°å›¾é¡µé¢
- [x] Heap ç«ç„°å›¾é¡µé¢
- [x] SVG ç›´æ¥åµŒå…¥æ˜¾ç¤º
- [x] ç§»é™¤ç¼©æ”¾åŠŸèƒ½ï¼ˆä½¿ç”¨æµè§ˆå™¨åŸç”Ÿç¼©æ”¾ï¼‰

**å…³é”®ä¿®å¤**:
- pprof SVG ä½¿ç”¨è´Ÿåæ ‡ `viewBox="0 -1000 2000 1000"`
- è½¬æ¢ä¸ºæ­£åæ ‡ `viewBox="0 0 2000 1000"` ä½¿å†…å®¹å¯è§
- ç§»é™¤å›ºå®šé«˜åº¦é™åˆ¶ï¼Œæ”¯æŒæµè§ˆå™¨æ— é™ç¼©æ”¾

### 5. Profile æ•°æ®å¤„ç†

#### 5.1 æ•°æ®æ ¼å¼æ”¯æŒ âœ…
- [x] gperftools åŸå§‹ profile æ ¼å¼
- [x] Collapsed stack trace æ ¼å¼
- [x] SVG æ ¼å¼è¾“å‡º

#### 5.2 æ•°æ®è§£æ âœ…
- [x] è§£æ gperftools binary profile
- [x] æå– PC æŒ‡é’ˆå’Œè°ƒç”¨æ ˆ
- [x] ç¬¦å·åŒ– PC åœ°å€
- [x] ç”Ÿæˆ collapsed æ ¼å¼

### 6. æ„å»ºç³»ç»Ÿ

#### 6.1 ä¾èµ–ç®¡ç† âœ…
- [x] ä½¿ç”¨ vcpkg ç®¡ç†ä¾èµ–
- [x] è‡ªåŠ¨ä¸‹è½½å’Œé…ç½®ä¾èµ–åº“
- [x] æ”¯æŒç¦»çº¿æ„å»º

**ä¸»è¦ä¾èµ–**:
- drogon (C++ Web æ¡†æ¶)
- jsoncpp (JSON è§£æ)
- gperftools (æ€§èƒ½åˆ†æåº“)
- tracy (å¯é€‰çš„è·Ÿè¸ªå·¥å…·)
- backward-cpp (ç¬¦å·åŒ–)

#### 6.2 æ„å»ºè„šæœ¬ âœ…
- [x] `CMakeLists.txt` é…ç½®
- [x] `full_build.sh` ä¸€é”®æ„å»ºè„šæœ¬
- [x] åµŒå…¥å¼ pprof è„šæœ¬
- [x] è‡ªåŠ¨ç”Ÿæˆ pprof è„šæœ¬æ–‡ä»¶

---

## å¾…å®ŒæˆåŠŸèƒ½ â³

### 1. ç¬¦å·åŒ–ä¼˜åŒ– ğŸ”´

#### é—®é¢˜æè¿°
**å½“å‰çŠ¶æ€**: pprof ç”Ÿæˆçš„ SVG æ˜¾ç¤ºåœ°å€è€Œéå‡½æ•°å

**åŸå› **:
- pprof Perl è„šæœ¬æ— æ³•æ­£ç¡®ç¬¦å·åŒ– PIE å¯æ‰§è¡Œæ–‡ä»¶çš„è¿è¡Œæ—¶åœ°å€
- gperftools é‡‡æ ·çš„æ˜¯è¿è¡Œæ—¶åœ°å€ï¼ˆ0x000061...ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºé“¾æ¥æ—¶åœ°å€

**æµ‹è¯•ç»“æœ**:
```
# ä½¿ç”¨ /proc/self/exe:
Total: 6 samples
       1  16.7%  16.7%        1  16.7% ?? ??:0
       1  16.7%  33.3%        1  16.7% ?? ??:0

# ä½¿ç”¨ç»å¯¹è·¯å¾„:
       1  16.7%  16.7%        1  16.7% 0x0000610a7fc6280b
```

**è§£å†³æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ A**: ä½¿ç”¨ FlameGraph ç”Ÿæˆ SVG âœ… å·²å®ç°
- ä½¿ç”¨æœåŠ¡å™¨ç«¯ç¬¦å·åŒ– (`getCollapsedStacks`)
- ä½¿ç”¨ FlameGraph å·¥å…·ç”Ÿæˆ SVG
- ä¼˜ç‚¹: ç¬¦å·åŒ–æ­£ç¡®ï¼Œæ˜¾ç¤ºå‡½æ•°å
- ç¼ºç‚¹: ä¸æ˜¯ pprof çš„è°ƒç”¨å›¾æ ¼å¼

**æ–¹æ¡ˆ B**: ä¿®å¤ pprof ç¬¦å·åŒ– (æœªå®ç°)
- ä¿®æ”¹ pprof Perl è„šæœ¬çš„ç¬¦å·åŒ–é€»è¾‘
- æˆ–è€…ä½¿ç”¨ nm/addr2line é¢„å¤„ç†
- ä¼˜ç‚¹: ä¿æŒ pprof åŸç”Ÿæ ¼å¼
- ç¼ºç‚¹: å·¥ä½œé‡å¤§ï¼Œéœ€è¦æ·±å…¥ Perl è„šæœ¬

**å½“å‰é€‰æ‹©**: æ–¹æ¡ˆ A (ä½¿ç”¨ FlameGraph)

**å®ç°ä»£ç **:
```cpp
// src/profiler_manager.cpp::analyzeCPUProfile()
std::string collapsed_data = getCollapsedStacks("cpu");
std::ostringstream cmd;
cmd << "perl /tmp/FlameGraph/flamegraph.pl " << collapsed_file;
```

### 2. SVG æ¸²æŸ“ä¼˜åŒ– ğŸŸ¡

#### 2.1 æµè§ˆå™¨ç¼©æ”¾é™åˆ¶
- [x] ç§»é™¤å›ºå®šå®¹å™¨é«˜åº¦
- [x] SVG height è®¾ç½®ä¸º auto
- [x] æ”¯æŒæµè§ˆå™¨æ— é™ç¼©æ”¾
- [ ] æ½œåœ¨é—®é¢˜: SVG è¿‡å¤§æ—¶æ€§èƒ½ä¼˜åŒ–

#### 2.2 è´Ÿåæ ‡å¤„ç†
- [x] ä¿®æ”¹ viewBox è§£å†³ pprof è´Ÿåæ ‡é—®é¢˜
- [ ] è€ƒè™‘: åŠ¨æ€è®¡ç®—å®é™…å†…å®¹çš„è¾¹ç•Œæ¡†
- [ ] è€ƒè™‘: æ·»åŠ å¹³ç§»/ç¼©æ”¾æ‰‹åŠ¿æ”¯æŒ

### 3. é”™è¯¯å¤„ç†å’Œå¥å£®æ€§

#### 3.1 å¼‚å¸¸æƒ…å†µå¤„ç† â³
- [ ] Profiler å¯åŠ¨å¤±è´¥å¤„ç†
- [ ] Profile æ–‡ä»¶æŸåæ£€æµ‹
- [ ] ç¬¦å·åŒ–å¤±è´¥é™çº§ç­–ç•¥
- [ ] ç½‘ç»œé”™è¯¯å¤„ç†

#### 3.2 æ—¥å¿—å’Œè°ƒè¯• â³
- [ ] ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- [ ] è°ƒè¯•æ¨¡å¼å¼€å…³
- [ ] æ€§èƒ½æŒ‡æ ‡æ”¶é›†

### 4. é«˜çº§ç‰¹æ€§

#### 4.1 æ•°æ®å¯¼å‡º ğŸŸ¡
- [x] Profile æ–‡ä»¶ä¸‹è½½
- [ ] Speedscope æ ¼å¼æ”¯æŒ
- [ ] pprof protobuf æ ¼å¼æ”¯æŒ
- [ ] CSV/JSON æ ¼å¼å¯¼å‡º

#### 4.2 å®æ—¶ç›‘æ§ ğŸŸ¡
- [ ] WebSocket å®æ—¶æ›´æ–°
- [ ] æµå¼æ•°æ®ä¼ è¾“
- [ ] å®æ—¶ç«ç„°å›¾æ›´æ–°

#### 4.3 å¤šè¿›ç¨‹æ”¯æŒ ğŸ”´
- [ ] è¿›ç¨‹åˆ—è¡¨æ˜¾ç¤º
- [ ] é€‰æ‹©ç‰¹å®šè¿›ç¨‹è¿›è¡Œ profiling
- [ ] è¿œç¨‹æœºå™¨ profiling

### 5. æ€§èƒ½ä¼˜åŒ–

#### 5.1 åç«¯ä¼˜åŒ– â³
- [ ] å¼‚æ­¥ profiling å¯åŠ¨
- [ ] Profile æ•°æ®æµå¼å¤„ç†
- [ ] ç¬¦å·åŒ–ç¼“å­˜
- [ ] å‡å°‘å†…å­˜æ‹·è´

#### 5.2 å‰ç«¯ä¼˜åŒ– ğŸŸ¡
- [ ] è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§ SVGï¼‰
- [ ] æ‡’åŠ è½½
- [ ] Web Worker è§£æ
- [ ] å‹ç¼©ä¼ è¾“

### 6. æ–‡æ¡£å’Œæµ‹è¯•

#### 6.1 æ–‡æ¡£ â³
- [ ] API æ–‡æ¡£ç”Ÿæˆ
- [ ] ç”¨æˆ·æ‰‹å†Œ
- [ ] å¼€å‘è€…æŒ‡å—
- [ ] æ¶æ„è®¾è®¡æ–‡æ¡£

#### 6.2 æµ‹è¯• â³
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## è®¾è®¡æ–‡æ¡£

### 1. Profiler Manager è®¾è®¡

**èŒè´£**:
- ç®¡ç† profiler ç”Ÿå‘½å‘¨æœŸï¼ˆå¯åŠ¨/åœæ­¢ï¼‰
- åè°ƒ profiling æµç¨‹
- æä¾› API æ¥å£

**å…³é”®æ–¹æ³•**:
```cpp
class ProfilerManager {
public:
    // CPU Profiling
    bool startCPUProfiler(const std::string& output_path = "");
    bool stopCPUProfiler();
    std::string analyzeCPUProfile(int duration, const std::string& output_type);

    // Heap Profiling
    bool startHeapProfiler(const std::string& output_path = "");
    bool stopHeapProfiler();
    std::string analyzeHeapProfile(int duration, const std::string& output_type);

    // æ•°æ®æŸ¥è¯¢
    std::string getStatus();
    std::string getProfileSamples(const std::string& profile_type);
    std::string getCollapsedStacks(const std::string& profile_type);
};
```

### 2. ç¬¦å·åŒ–å¼•æ“è®¾è®¡

**æ¶æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Symbolization Pipeline          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. backward-cpp (ä¼˜å…ˆ)                  â”‚
â”‚    - C++ stack trace                    â”‚
â”‚    - æºç çº§ä¿¡æ¯                        â”‚
â”‚         â†“                                â”‚
â”‚ 2. dladdr (åŠ¨æ€é“¾æ¥)                    â”‚
â”‚    - å…±äº«åº“ç¬¦å·                         â”‚
â”‚    - å‡½æ•°åæ˜ å°„                         â”‚
â”‚         â†“                                â”‚
â”‚ 3. addr2line (ç¬¦å·è¡¨)                   â”‚
â”‚    - ç²¾ç¡®æ–‡ä»¶å’Œè¡Œå·                     â”‚
â”‚    - ç›¸å¯¹åœ°å€è®¡ç®—                       â”‚
â”‚         â†“                                â”‚
â”‚ 4. åŸå§‹åœ°å€ (é™çº§)                      â”‚
â”‚    - 0x... æ ¼å¼                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PIE å¯æ‰§è¡Œæ–‡ä»¶å¤„ç†**:
```cpp
// è®¡ç®—ç›¸å¯¹åœ°å€
Dl_info info;
dladdr(address, &info);
uintptr_t relative_addr = addr - reinterpret_cast<uintptr_t>(info.dli_fbase);

// ä½¿ç”¨ addr2line ç¬¦å·åŒ–
std::ostringstream cmd;
cmd << "addr2line -e " << info.dli_fname << " -f -C 0x"
    << std::hex << relative_addr;
```

### 3. Web API è®¾è®¡

#### 3.1 API ç«¯ç‚¹è§„èŒƒ

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| `/api/status` | GET | è·å–å…¨å±€çŠ¶æ€ | âœ… |
| `/api/cpu/start` | GET | å¯åŠ¨ CPU profiler | âœ… |
| `/api/cpu/stop` | GET | åœæ­¢ CPU profiler | âœ… |
| `/api/cpu/analyze` | GET | åˆ†æå¹¶ç”Ÿæˆ SVG | âœ… |
| `/api/cpu/status` | GET | CPU profiler çŠ¶æ€ | âœ… |
| `/api/cpu/profile` | GET | ä¸‹è½½ profile æ–‡ä»¶ | âœ… |
| `/api/cpu/text` | GET | æ–‡æœ¬æ ¼å¼ç»“æœ | âœ… |
| `/api/cpu/samples` | GET | åŸå§‹é‡‡æ ·æ•°æ® | âœ… |
| `/api/cpu/collapsed` | GET | Collapsed æ ¼å¼ | âœ… |
| `/api/heap/start` | GET | å¯åŠ¨ heap profiler | âœ… |
| `/api/heap/stop` | GET | åœæ­¢ heap profiler | âœ… |
| `/api/heap/analyze` | GET | åˆ†æå¹¶ç”Ÿæˆ SVG | âœ… |
| `/api/heap/status` | GET | Heap profiler çŠ¶æ€ | âœ… |
| `/api/heap/profile` | GET | ä¸‹è½½ profile æ–‡ä»¶ | âœ… |

#### 3.2 å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
    "cpu_profiler": {
        "is_running": true,
        "output_path": "/tmp/cpp_profiler/cpu.prof",
        "duration": 5
    }
}
```

**é”™è¯¯å“åº”**:
```json
{
    "error": "Failed to start CPU profiler"
}
```

### 4. å‰ç«¯æ¶æ„

#### 4.1 é¡µé¢ç»“æ„
```
index.html (ä¸»æ§åˆ¶é¢æ¿)
  â”œâ”€â”€ CPU Profiler æ§åˆ¶
  â”œâ”€â”€ Heap Profiler æ§åˆ¶
  â””â”€â”€ çŠ¶æ€æ˜¾ç¤º

show_svg.html (CPU ç«ç„°å›¾)
  â”œâ”€â”€ SVG å®¹å™¨
  â”œâ”€â”€ æ§åˆ¶æŒ‰é’®
  â””â”€â”€ æç¤ºä¿¡æ¯

show_heap_svg.html (Heap ç«ç„°å›¾)
  â”œâ”€â”€ SVG å®¹å™¨
  â”œâ”€â”€ æ§åˆ¶æŒ‰é’®
  â””â”€â”€ æç¤ºä¿¡æ¯
```

#### 4.2 SVG æ˜¾ç¤ºæ–¹æ¡ˆ

**pprof SVG**:
- æ ¼å¼: è°ƒç”¨å›¾ (Call Graph)
- åæ ‡ç³»ç»Ÿ: è´Ÿåæ ‡ (viewBox="0 -1000 2000 1000")
- é—®é¢˜: æ˜¾ç¤ºåœ°å€è€Œéå‡½æ•°å

**FlameGraph SVG** (å½“å‰æ–¹æ¡ˆ):
- æ ¼å¼: ç«ç„°å›¾ (Flame Graph)
- åæ ‡ç³»ç»Ÿ: æ­£åæ ‡ (viewBox="0 0 1200 214")
- ä¼˜ç‚¹: æ­£ç¡®æ˜¾ç¤ºå‡½æ•°å
- å®ç°: æœåŠ¡å™¨ç«¯ç¬¦å·åŒ– + FlameGraph å·¥å…·

### 5. éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Client Browser                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Nginx / Reverse Proxy          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      C++ Remote Profiler (Drogon)         â”‚
â”‚  - HTTP Server (port 8080)                â”‚
â”‚  - Static Files (/web/*)                   â”‚
â”‚  - API Handlers (/api/*)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯å†³ç­–è®°å½•

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ gperftools è€Œéå…¶ä»– profilerï¼Ÿ
- **ä¼˜åŠ¿**: æˆç†Ÿç¨³å®šï¼ŒGoogle ç”Ÿäº§ç¯å¢ƒéªŒè¯
- **ç”Ÿæ€**: ä¸ pprof å·¥å…·é“¾å…¼å®¹
- **å¼€é”€ä½**: é‡‡æ ·å¼€é”€å°ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ
- **åŠŸèƒ½**: åŒæ—¶æ”¯æŒ CPU å’Œ Heap profiling

### 2. ä¸ºä»€ä¹ˆé€‰æ‹© Drogon æ¡†æ¶ï¼Ÿ
- **é«˜æ€§èƒ½**: å¼‚æ­¥ I/Oï¼Œä½å»¶è¿Ÿ
- **C++ åŸç”Ÿ**: ä¸ profiler æ— ç¼é›†æˆ
- **æ˜“ç”¨**: ç±»ä¼¼ Express.js çš„è·¯ç”±è¯­æ³•
- **åŠŸèƒ½ä¸°å¯Œ**: ORMã€WebSocketã€Session ç­‰

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨ vcpkg ç®¡ç†ä¾èµ–ï¼Ÿ
- **è·¨å¹³å°**: æ”¯æŒ Linux/Windows/macOS
- **ç‰ˆæœ¬æ§åˆ¶**: é”å®šç‰¹å®šç‰ˆæœ¬
- **è‡ªåŠ¨åŒ–**: ä¸€é”®å®‰è£…å’Œæ„å»º
- **ç¤¾åŒºæ”¯æŒ**: Microsoft å®˜æ–¹æ”¯æŒ

### 4. ä¸ºä»€ä¹ˆä½¿ç”¨ FlameGraph è€Œé pprof SVGï¼Ÿ
- **ç¬¦å·åŒ–**: FlameGraph æ–¹æ¡ˆèƒ½æ­£ç¡®æ˜¾ç¤ºå‡½æ•°å
- **å…¼å®¹æ€§**: pprof å¯¹ PIE å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒä¸ä½³
- **æ§åˆ¶æƒ**: FlameGraph æ›´å®¹æ˜“è‡ªå®šä¹‰å’Œæ‰©å±•
- **æ€§èƒ½**: æœåŠ¡å™¨ç«¯ç¬¦å·åŒ–ï¼Œæµè§ˆå™¨ç›´æ¥æ˜¾ç¤º

---

## å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

### 1. pprof ç¬¦å·åŒ–é—®é¢˜ ğŸ”´
**é—®é¢˜**: pprof Perl è„šæœ¬æ— æ³•ç¬¦å·åŒ– PIE å¯æ‰§è¡Œæ–‡ä»¶
**å½±å“**: pprof SVG æ˜¾ç¤ºåœ°å€è€Œéå‡½æ•°å
**è§£å†³**: ä½¿ç”¨ FlameGraph æ›¿ä»£ pprof
**çŠ¶æ€**: âœ… å·²è§£å†³

### 2. SVG æµè§ˆå™¨ç¼©æ”¾é™åˆ¶ ğŸŸ¡
**é—®é¢˜**: å®¹å™¨å›ºå®šé«˜åº¦é™åˆ¶æµè§ˆå™¨ç¼©æ”¾
**å½±å“**: ç”¨æˆ·æ— æ³•æ— é™æ”¾å¤§æŸ¥çœ‹ç»†èŠ‚
**è§£å†³**: ç§»é™¤å›ºå®šé«˜åº¦ï¼Œä½¿ç”¨ auto
**çŠ¶æ€**: âœ… å·²è§£å†³

### 3. æ€§èƒ½å¼€é”€ ğŸŸ¢
**é—®é¢˜**: Profiling ä¼šå¢åŠ ç¨‹åºå¼€é”€
**å½±å“**: CPU 1-5%ï¼Œå†…å­˜é¢å¤–åˆ†é…
**ç¼“è§£**: ä½é¢‘é‡‡æ ·ï¼Œå¯é…ç½®é‡‡æ ·é¢‘ç‡

### 4. ç¬¦å·åŒ–ä¸å®Œæ•´ ğŸŸ¡
**é—®é¢˜**: éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨æ— æ³•ç¬¦å·åŒ–
**å½±å“**: æ˜¾ç¤ºä¸ºåŸå§‹åœ°å€æˆ–å…±äº«åº“å
**ç¼“è§£**: å¤šå±‚ç¬¦å·åŒ–ç­–ç•¥ï¼Œå°½åŠ›è§£æ

---

## æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡ (1-2 å‘¨)
1. [ ] å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
2. [ ] æ·»åŠ  Speedscope æ ¼å¼æ”¯æŒ
3. [ ] ä¼˜åŒ–å¤§ SVG çš„æ¸²æŸ“æ€§èƒ½
4. [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### ä¸­æœŸç›®æ ‡ (1-2 æœˆ)
1. [ ] WebSocket å®æ—¶æ›´æ–°
2. [ ] å¤šè¿›ç¨‹æ”¯æŒ
3. [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå¼‚æ­¥ã€ç¼“å­˜ï¼‰
4. [ ] å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

### é•¿æœŸç›®æ ‡ (3-6 æœˆ)
1. [ ] åˆ†å¸ƒå¼ profiling
2. [ ] å¯è§†åŒ–æ€§èƒ½å¯¹æ¯”
3. [ ] è‡ªåŠ¨åŒ–æ€§èƒ½åˆ†ææŠ¥å‘Š
4. [ ] Docker éƒ¨ç½²æ–¹æ¡ˆ

---

## å¼€å‘è§„èŒƒ

### åˆ†æ”¯ç®¡ç†
- âœ… æ°¸è¿œä¸è¦ç›´æ¥æäº¤åˆ° main åˆ†æ”¯
- âœ… åœ¨è¿›è¡Œä¿®æ”¹ä¹‹å‰ï¼Œå…ˆåˆ›å»ºæ–°åˆ†æ”¯
- âœ… ä½¿ç”¨ `git checkout -b <branch-name>` åˆ›å»ºæ–°åˆ†æ”¯

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ C++20 æ ‡å‡†
- éµå¾ª Google C++ Style Guide
- æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£

### æµ‹è¯•è§„èŒƒ
- ç¼–è¯‘å‰è¿è¡Œ `cmake --build .`
- æµ‹è¯•å…³é”®åŠŸèƒ½è·¯å¾„
- éªŒè¯ç¬¦å·åŒ–æ˜¯å¦æ­£ç¡®

---

## å‚è€ƒèµ„æº

- [gperftools Documentation](https://github.com/gperftools/gperftools)
- [FlameGraph Tool](https://github.com/brendangregg/FlameGraph)
- [Drogon Framework](https://github.com/drogonframework/drogon)
- [vcpkg Package Manager](https://github.com/microsoft/vcpkg)
- [backward-cpp](https://github.com/bombela/backward-cpp)

---

## æ›´æ–°æ—¥å¿—

### 2026-01-11
- âœ… ç§»é™¤ç«ç„°å›¾ç¼©æ”¾åŠŸèƒ½
- âœ… ä¿®å¤ SVG è´Ÿåæ ‡æ˜¾ç¤ºé—®é¢˜
- âœ… æ”¯æŒæµè§ˆå™¨æ— é™ç¼©æ”¾
- ğŸ” è°ƒæŸ¥ pprof ç¬¦å·åŒ–é—®é¢˜
- ğŸ“ åˆ›å»º plan.md æ–‡æ¡£

### 2026-01-10
- âœ… å®ç°ä¸€é”®å¼ CPU/Heap åˆ†æ
- âœ… æ”¹è¿›ç¬¦å·åŒ–ç³»ç»Ÿ
- âœ… æ·»åŠ  collapsed æ ¼å¼æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-11
**ç»´æŠ¤è€…**: Claude Code
