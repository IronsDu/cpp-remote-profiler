<!DOCTYPE html>
<html>
<head>
    <title>Canvasç«ç„°å›¾è°ƒè¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        #canvas { border: 2px solid #333; background: #f5f5f5; margin: 20px 0; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; border-left: 4px solid #ffc107; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Canvasç«ç„°å›¾è°ƒè¯•</h1>

    <div class="debug">
        <strong>è°ƒè¯•ä¿¡æ¯:</strong>
        <div id="debugInfo"></div>
    </div>

    <canvas id="canvas" width="1200" height="600"></canvas>

    <div class="debug">
        <strong>æ¸²æŸ“æ—¥å¿—:</strong>
        <pre id="renderLog"></pre>
    </div>

    <script>
        const debugInfo = document.getElementById('debugInfo');
        const renderLog = document.getElementById('renderLog');
        const logs = [];

        function log(msg) {
            logs.push(msg);
            renderLog.textContent = logs.join('\n');
            console.log(msg);
        }

        async function test() {
            log('å¼€å§‹è°ƒè¯•...\n');

            // è·å–ç«ç„°å›¾æ•°æ®
            const response = await fetch('/api/cpu/flamegraph');
            const data = await response.json();

            log('JSONæ•°æ®:');
            log(JSON.stringify(data, null, 2));
            log('\n');

            // è®¡ç®—æ€»å€¼
            const total = data.total || 0;
            log(`Total: ${total}`);
            log(`Childrenæ•°é‡: ${data.children.length}`);
            log('\n');

            // è·å–Canvas
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // æ¸…ç©º
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è®¡ç®—å‡½æ•°
            function calculateNodeTotal(node) {
                if (!node) return 0;
                if (node.value) return node.value;
                if (!node.children) return 0;

                let sum = 0;
                for (const child of node.children) {
                    sum += calculateNodeTotal(child);
                }
                return sum;
            }

            // æ¸²æŸ“èŠ‚ç‚¹
            function renderNode(node, x, y, width, depth, total) {
                if (!node || !node.children) {
                    log(`è·³è¿‡èŠ‚ç‚¹: ${node?.name} (æ— children)`);
                    return;
                }

                const renderWidth = width;
                const totalValue = node.value || calculateNodeTotal(node);

                log(`æ¸²æŸ“èŠ‚ç‚¹: ${node.name}`);
                log(`  - ä½ç½®: x=${x.toFixed(2)}, y=${y}`);
                log(`  - å®½åº¦: ${width.toFixed(2)}`);
                log(`  - totalValue: ${totalValue}`);
                log(`  - childrenæ•°é‡: ${node.children.length}`);
                log('\n');

                if (totalValue <= 0) {
                    log(`  âš ï¸  totalValueä¸º0ï¼Œè·³è¿‡æ¸²æŸ“\n`);
                    return;
                }

                let currentX = x;
                const barHeight = 30;

                for (const child of node.children) {
                    // è®¡ç®—å­èŠ‚ç‚¹çš„å€¼
                    const childValue = child.value || calculateNodeTotal(child);

                    if (childValue <= 0) {
                        log(`  è·³è¿‡å­èŠ‚ç‚¹ ${child.name}: value=${childValue}\n`);
                        continue;
                    }

                    const childWidth = (childValue / totalValue) * renderWidth;

                    if (childWidth < 1) {
                        log(`  å­èŠ‚ç‚¹ ${child.name} å¤ªçª„: ${childWidth.toFixed(2)}px\n`);
                        continue;
                    }

                    // ç»˜åˆ¶
                    const color = `hsl(${Math.random() * 60}, 70%, 60%)`;
                    ctx.fillStyle = color;
                    ctx.fillRect(currentX, y + depth * (barHeight + 2), childWidth, barHeight);

                    // ç»˜åˆ¶è¾¹æ¡†
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(currentX, y + depth * (barHeight + 2), childWidth, barHeight);

                    // ç»˜åˆ¶æ–‡å­—
                    if (childWidth > 50) {
                        ctx.fillStyle = 'white';
                        ctx.font = '11px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(child.name, currentX + childWidth/2, y + depth * (barHeight + 2) + barHeight/2);
                    }

                    log(`  âœ“ æ¸²æŸ“ ${child.name}: value=${childValue}, width=${childWidth.toFixed(2)}px, x=${currentX.toFixed(2)}`);

                    // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
                    renderNode(child, currentX, y, childWidth, depth + 1, total);

                    currentX += childWidth;
                }
            }

            // å¼€å§‹æ¸²æŸ“
            const margin = 20;
            renderNode(data, margin, margin, canvas.width - 2*margin, 0, total);

            log('æ¸²æŸ“å®Œæˆï¼');
            debugInfo.innerHTML = `
                <p>Canvaså°ºå¯¸: ${canvas.width}x${canvas.height}</p>
                <p>æ¸²æŸ“çš„çŸ©å½¢æ•°é‡: ${(ctx.fillStyle || '').length}</p>
                <p>æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†æ—¥å¿—</p>
            `;
        }

        // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
        window.onload = test;
    </script>
</body>
</html>
